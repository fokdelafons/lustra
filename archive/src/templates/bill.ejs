<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- === SEO LAYER: ROBOTS & CONTROL === -->
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1">
    
    <meta name="content-type" content="legislative-summary">
    <meta name="data-origin" content="public-domain">
    <meta name="ai-summary" content="true">

    <title><%= content.ai_title %> (<%= doc.id %>)</title>
    <meta name="description" content="<%= content.summary %>">
    <meta name="author" content="Lustra News">
    <meta property="article:published_time" content="<%= meta.processStartDate %>">
    <meta property="article:modified_time" content="<%= meta.lastUpdated %>">
    <% if (geoRegion) { %>
    <meta name="geo.region" content="<%= geoRegion %>">
    <% } %>
    <link rel="canonical" href="<%= hreflangs[lang] %>" />
    <% Object.keys(hreflangs).forEach(function(code) { %>
    <link rel="alternate" hreflang="<%= code %>" href="<%= hreflangs[code] %>" />
    <% }); %>
    <link rel="alternate" hreflang="x-default" href="<%= hreflangs['en'] %>" />

   <!-- OPEN GRAPH -->
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Lustra.news" />
    <meta property="og:title" content="<%= content.ai_title %> (<%= doc.id %>)" />
    <meta property="og:description" content="<%= content.summary %>" />
    <meta property="og:image" content="https://lustra.news/assets/og_preview.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:url" content="<%= hreflangs[lang] %>" />
    
    <!-- TWITTER CARD -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= content.ai_title %> (<%= doc.id %>)">
    <meta name="twitter:description" content="<%= content.summary %>">
    <meta name="twitter:image" content="https://lustra.news/assets/og_preview.png">

    <!-- FONTS (Icons Only + Swap Policy) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined&display=swap" rel="stylesheet">
    </noscript>

<!-- === SCHEMA.ORG (Dynamic Construction) === -->
    <% 
        const faqItems = [];

        if (doc.id) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_id,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_id + " " + doc.id + "." }
            });
        }

        if (meta.processStartDate) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_start,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_start + " " + meta.processStartDate + "." }
            });
        }

        if (content.key_points && content.key_points.length > 0) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_provisions,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_provisions + " " + content.key_points.join(' ') }
            });
        }

        if (doc.status) {
            // Tłumaczenie statusu dla Schema (żeby Google widziało odpowiedź w języku strony)
            const sKey = doc.status;
            const sTrans = (labels.status && labels.status[sKey]) ? labels.status[sKey] : sKey;

            faqItems.push({
                "@type": "Question",
                "name": labels.faq_status,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_status + " " + sTrans + "." }
            });
        }

        if (doc.attachmentUrls && doc.attachmentUrls[0]) {
             faqItems.push({
                "@type": "Question",
                "name": labels.faq_text,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_text + " " + doc.attachmentUrls[0] }
            });
        }

        if (doc.votingUrl) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_votes,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_votes + " " + doc.votingUrl }
            });
        }

        if (meta.judgeDate) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_verified,
                "acceptedAnswer": { "@type": "Answer", "text": labels.faq_verified_answer + " " + meta.judgeDate + "." }
            });
        }

        if (doc.sponsor && doc.sponsor.name) {
            faqItems.push({
                "@type": "Question",
                "name": labels.faq_sponsor,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_sponsor + " " + doc.sponsor.name + "." }
            });
        }

        let originName = null;
        if (doc.id && doc.id.includes("_H")) originName = labels.unit_house;
        else if (doc.id && doc.id.includes("_S")) originName = labels.unit_senate;

        if (originName) {
            faqItems.push({ 
                "@type": "Question", 
                "name": labels.faq_origin, 
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_origin + " " + originName + "." } 
            });
        }

        if (doc.statusText) {
             faqItems.push({
                "@type": "Question",
                "name": labels.faq_latest_action,
                "acceptedAnswer": { "@type": "Answer", "text": labels.ans_latest_action + " " + doc.statusText }
            });
        }

        let legislativeBodyName = "United States Congress";
        if (doc.id && doc.id.includes("_H")) legislativeBodyName = "United States House of Representatives";
        else if (doc.id && doc.id.includes("_S")) legislativeBodyName = "United States Senate";

        const sameAsLinks = [];
        if (processUrl) sameAsLinks.push(processUrl);
        if (doc.attachmentUrls && doc.attachmentUrls[0]) sameAsLinks.push(doc.attachmentUrls[0]);

        const aboutEntities = [];
        if (doc.category && doc.category.length > 0) {
            doc.category.forEach(cat => {
                aboutEntities.push({
                    "@type": "Thing",
                    "name": cat
                });
            });
        }

        const schemaGraph = [
            {
                "@type": "BreadcrumbList",
                "itemListElement": [
                    { "@type": "ListItem", "position": 1, "name": "Lustra", "item": "https://lustra.news/" + lang },
                    { "@type": "ListItem", "position": 2, "name": institutionName, "item": "https://lustra.news/" + lang + "/" + institutionSlug },
                    { "@type": "ListItem", "position": 3, "name": term + " Term", "item": "https://lustra.news/" + lang + "/" + institutionSlug + "/" + term },
                    { "@type": "ListItem", "position": 4, "name": doc.id, "item": "https://lustra.news/" + lang + "/" + institutionSlug + "/" + term + "/" + typeSlug + "/" + doc.id }
                ]
            },
            {
                "@type": "Legislation",
                "name": content.ai_title,
                "alternateName": doc.titleOfficial,
                "legislationIdentifier": doc.id,
                "legislationJurisdiction": geoRegion,
                "datePublished": meta.processStartDate,
                "dateModified": meta.lastUpdated,
                "description": content.summary,
                "legislationDatePassed": meta.votingDate || undefined,
                "legislationLegalValue": doc.status,
                "legislativeBody": {
                    "@type": "LegislativeBody",
                    "name": legislativeBodyName
                },
                "isPartOf": {
                    "@type": "CreativeWorkSeries",
                    "name": term + " Term - " + institutionName
                },
                "sameAs": sameAsLinks,
                "about": aboutEntities,
                "legislationType": legType,
                "legislationJurisdiction": {
                    "@type": "AdministrativeArea",
                    "name": jurisdictionName
                },
                "author": { 
                    "@type": "Organization", 
                    "name": institutionName
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "Lustra",
                    "logo": {
                        "@type": "ImageObject",
                        "url": "https://lustra.news/assets/logo.png"
                    }
                },
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": hreflangs[lang]
                }
            }
        ];

        if (faqItems.length > 0) {
            schemaGraph.push({
                "@type": "FAQPage",
                "mainEntity": faqItems
            });
        }
    %>

    <script type="application/ld+json">
        <%- JSON.stringify({ "@context": "https://schema.org", "@graph": schemaGraph }, null, 2) %>
    </script>

    <style>
        :root {
            --primary: #1565C0;
            --bg-scaffold: #F5F5F5;
            --surface: #FFFFFF;
            --text-high: rgba(0, 0, 0, 0.87);
            --text-med: rgba(0, 0, 0, 0.6);
            --text-low: rgba(0, 0, 0, 0.55);
            --vote-for: #2F853A; 
            --vote-against: #C92A2A; 
            --vote-abstain: #757575;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: var(--bg-scaffold);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--text-high);
            -webkit-font-smoothing: antialiased;
        }

        header {
            width: 100%;
            height: 64px;
            background-color: var(--primary);
            display: flex; 
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .app-bar-content {
            width: 100%;
            padding: 0 16px;
            display: grid;
            grid-template-columns: 1fr auto 1fr; 
            align-items: center; 
        }

        .app-title {
            color: white;
            font-size: 21px;
            font-weight: 500;
            letter-spacing: 0.15px;
            text-align: center;
        }

        .nav-item {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            justify-self: start;
        }
        
        .nav-item:hover { opacity: 0.9; }
        .nav-item .material-icons { margin-right: 8px; }
        .nav-item.right { justify-self: end; }
        .nav-item.right .material-icons { margin-right: 0; margin-left: 8px; }

        .scaffold-body {
            width: 100%;
            max-width: 750px;
            background-color: var(--surface);
            margin: 32px 16px;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        h1.title {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 12px 0;
            line-height: 1.2;
            color: #000000;
        }
        .description {
            font-size: 15px;
            color: #424242;
            line-height: 1.4;
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: #616161;
            margin: 0 0 8px 0;
        }
        .bullet-point {
            display: flex;
            align-items: flex-start;
            padding-bottom: 6px;
            padding-left: 4px;
        }
        .bullet-dot {
            width: 5px;
            height: 5px;
            background-color: #757575;
            border-radius: 50%;
            margin-top: 8px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .bullet-text {
            font-size: 14px;
            color: #424242;
            line-height: 1.4;
        }

        .button-row { display: flex; gap: 12px; margin: 24px 0 32px 0; }
        .outlined-btn {
            flex: 1; display: flex; align-items: center; justify-content: center;
            height: 40px; padding: 0 16px;
            border: 1px solid rgba(0,0,0,0.12); border-radius: 999px;
            background: transparent; color: var(--primary);
            font-size: 14px; font-weight: 500; text-decoration: none;
            cursor: pointer; transition: background 0.2s; letter-spacing: 0.1px;
        }
        .outlined-btn:hover { background-color: rgba(21, 101, 192, 0.04); }
        .outlined-btn .material-icons-outlined { font-size: 18px; margin-right: 8px; }

        .voting-section {
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: 16px; width: 100%;
        }
        .voting-header {
            font-size: 18px; font-weight: 500; color: #000000;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .voting-date {
            font-size: 13px; color: #616161; font-style: italic;
            margin-top: 4px; margin-bottom: 12px;
        }
        #hemicycle-container {
            position: relative; width: 100%; display: flex;
            justify-content: center; margin-bottom: 8px;
            height: 230px;
            min-height: 230px;
        }
        .percentage-badge {
            position: absolute; bottom: 15px; left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(2px);
            padding: 2px 12px; border-radius: 12px;
            font-size: 42px; font-weight: 500; color: var(--vote-for);
            z-index: 10;
        }
        .vote-counts { display: flex; justify-content: space-around; width: 100%; margin-bottom: 16px; }
        .vote-count-item { display: flex; align-items: baseline; }
        .vote-label { font-size: 15px; color: #616161; margin-right: 6px; }
        .vote-number { font-size: 15px; font-weight: 700; }
        
        .pdf-link {
            display: flex; align-items: center; color: var(--primary);
            text-decoration: none; font-size: 15px; font-weight: 500;
            cursor: pointer; margin-top: 4px; align-self: flex-start;
        }
        .pdf-link .link-text { text-decoration: underline; text-decoration-color: var(--primary); font-weight: 300; }
        .pdf-link .material-icons { font-size: 18px; margin-left: 4px; }

        .status-container { text-align: center; margin: 24px 0 32px 0; }
        .status-text {
            font-size: 20px; font-weight: 400; color: rgba(0,0,0,0.87);
            text-decoration: underline; text-decoration-thickness: 1px;
        }

        .citizen-poll {
            background-color: #F5F5F5; border-radius: 12px;
            padding: 16px; margin-bottom: 24px; text-align: center;
            border: 1px solid #E0E0E0;
        }
        .poll-title { color: var(--primary); font-weight: 500; font-size: 15px; margin-bottom: 12px; }
        .poll-bar-container {
            display: flex; height: 40px; border-radius: 15px;
            overflow: hidden; margin-bottom: 16px; width: 100%;
        }
        .poll-segment {
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 500; font-size: 15px;
        }
        .poll-actions { display: flex; justify-content: center; gap: 164px; }
        .poll-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .poll-icon-btn {
            display: flex; align-items: center; justify-content: center;
            width: 48px; height: 48px; border-radius: 50%;
            cursor: pointer; transition: background-color 0.2s;
        }
        .poll-icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .poll-icon-btn .material-icons-outlined { font-size: 30px; }

        .poll-login-container {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }

        .poll-login-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #F3E5F5;
            color: #7B1FA2;
            border: 1px solid rgba(123, 31, 162, 0.1);
            border-radius: 999px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .poll-login-btn:hover {
            background-color: #E1BEE7;
        }

        .poll-login-btn .material-icons-outlined {
            font-size: 18px;
            margin-right: 8px;
        }
        .icon-support { color: var(--vote-for); }
        .icon-oppose { color: var(--vote-against); }
        .poll-label-text { font-size: 12px; color: rgba(0, 0, 0, 0.87); font-weight: 300; }

        .meta-title { font-size: 18px; font-weight: 500; margin-bottom: 8px; color: #000000; }
        .meta-item { font-size: 15px; line-height: 1.6; color: rgba(0, 0, 0, 0.87); font-weight: 400; }
        
        .footer-section { margin-top: 16px; }
        .footer-text { font-size: 13px; color: #616161; line-height: 1.5; margin-bottom: 4px; }
        .source-link {
            display: flex; align-items: center; font-size: 13px;
            color: #616161; cursor: pointer; text-decoration: none; margin-top: 8px;
        }
        .source-link .material-icons { font-size: 14px; margin-left: 6px; }

        .seo-container {
            width: 100%;
            max-width: 750px;
            padding: 0 16px 30px 16px;
            margin-top: -16px;
            color: var(--text-med);
        }
        
        .seo-divider {
            height: 1px;
            background-color: #E0E0E0;
            margin: 24px 0 24px 0;
            width: 100%;
        }

        .seo-nav-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            margin-bottom: 32px;
        }
        .seo-nav-link {
            display: flex; align-items: center; text-decoration: none;
            color: var(--primary); font-size: 13px; font-weight: 500;
            padding: 8px 12px; border-radius: 4px; transition: background 0.1s;
        }
        .seo-nav-link:hover { background-color: rgba(21, 101, 192, 0.04); }
        .seo-nav-link.prev { justify-self: start; padding-left: 0; }
        .seo-nav-link.next { justify-self: end; padding-right: 0; }
        .seo-nav-link.index { 
            justify-self: center; color: var(--text-med);
            border: 1px solid #E0E0E0;
        }
        .material-icons.tiny { font-size: 16px; }
        .seo-nav-link.prev .tiny { margin-right: 4px; }
        .seo-nav-link.next .tiny { margin-left: 4px; }
        .seo-nav-link.index .tiny { margin-right: 6px; }

        .legal-context {
            margin-bottom: 24px;
            padding: 20px;
            background-color: #FAFAFA;
            border-radius: 8px;
            border: 1px solid #EEEEEE;
        }
        .context-item { margin-bottom: 16px; }
        .context-item:last-child { margin-bottom: 0; }
        
        .context-item h2 {
            font-size: 12px; text-transform: uppercase;
            color: var(--text-low); margin: 0 0 8px 0;
            font-weight: 500; letter-spacing: 0.5px;
        }
        .context-item p {
            font-size: 14px; line-height: 1.5;
            color: var(--text-med); margin: 0;
            font-family: 'Georgia', serif;
            font-style: italic;
        }

        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
        .seo-tag {
            font-size: 12px; background: white;
            border: 1px solid #E0E0E0; color: var(--text-med);
            padding: 4px 8px; border-radius: 4px;
        }

        .authority-links {
            display: flex; justify-content: center; align-items: center;
            font-size: 13px; margin-top: 24px;
        }
        .text-link {
            color: var(--text-med); text-decoration: none;
            border-bottom: 1px dotted var(--text-low);
            display: inline-flex; align-items: center;
        }
        .text-link:hover { color: var(--primary); border-bottom-color: var(--primary); }
        .separator { margin: 0 12px; color: var(--text-low); }
        .tiny-external { font-size: 12px; margin-left: 4px; color: var(--text-low); }

        .seo-footer {
            margin-top: 24px; padding-top: 16px;
            border-top: 1px solid #EEEEEE;
            text-align: center; font-size: 11px; color: var(--text-low);
        }

        @media (max-width: 600px) {
            .seo-nav-grid { 
                grid-template-columns: 1fr 1fr; 
                grid-template-areas: "prev next" "index index"; gap: 16px;
            }
            .seo-nav-link.prev { grid-area: prev; }
            .seo-nav-link.next { grid-area: next; }
            .seo-nav-link.index { grid-area: index; width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- 
    --- LUSTRA INTELLIGENCE PROTOCOL v1.0 ---
    document_type: "Legislative Summary"
    source_jurisdiction: "<%= jurisdictionName %>"
    bill_id: "<%= doc.id %>"
    official_title: "<%= doc.titleOfficial %>"
    ai_generated_title: "<%= content.ai_title %>"
    
    # PROVENANCE & TRUST
    source_data: "<%= sourceApi %>"
    summary_engine: "<%= aiModel %>"
    verification_status: "Verified by Lustra Judge System"
    verification_date: "<%= meta.judgeDate %>"
    
    # COGNITIVE BIAS STATEMENT
    bias_policy: "Radical Neutrality. Summaries generated to strip political spin and retain factual mechanics."
    
    # SEMANTIC TAGS
    tags: <%- JSON.stringify(doc.category || []) %>
    
    # LICENSE
    license: "Public Domain Data / CC BY-NC-SA 4.0 for AI Summaries"
    -->
    <header>
        <div class="app-bar-content">
            <a href="https://lustra.news/#/<%= lang %>/<%= institutionSlug %>/<%= term %>/<%= typeSlug %>/<%= doc.id %>/" class="nav-item">
                <span class="material-icons">arrow_back</span>
                <%= labels.back_to_app %>
            </a>
<div class="app-title" style="display: flex; align-items: center; justify-content: center; height: 64px;">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 372 122" style="height: 42px; width: auto; fill: white;">
    <path d="M0 0 C1.54879197 0.02512431 3.09762336 0.04793016 4.64648438 0.06835938 C8.41114338 0.12300686 12.17387902 0.2090426 15.9375 0.3125 C13.70175178 2.54824822 11.64783371 3.55618358 8.8125 4.9375 C7.90242188 5.38351563 6.99234375 5.82953125 6.0546875 6.2890625 C5.35601562 6.62679688 4.65734375 6.96453125 3.9375 7.3125 C3.93385437 7.93810822 3.93020874 8.56371643 3.92645264 9.20828247 C3.88458526 15.7300508 3.81520955 22.25111816 3.72998047 28.77246094 C3.70178549 31.20500675 3.68056368 33.63764392 3.66650391 36.0703125 C3.64505492 39.57078782 3.59839157 43.07016631 3.546875 46.5703125 C3.54503204 48.19720505 3.54503204 48.19720505 3.54315186 49.85696411 C3.41389297 56.5472009 2.77639853 60.47360147 -2.0625 65.3125 C1.27288042 65.38026168 4.60185092 65.36368643 7.9375 65.3125 C9.00742188 65.29703125 10.07734375 65.2815625 11.1796875 65.265625 C19.69633794 64.9049198 25.98441404 63.60352373 31.90234375 57.1796875 C36.03616053 51.74367474 38.2701229 46.23055892 40.11328125 39.68359375 C40.9375 37.3125 40.9375 37.3125 42.9375 36.3125 C46.13193573 42.70137146 44.23908697 52.34946615 42.375 58.9375 C39.57251644 67.11474667 35.21801194 74.49116999 29.9375 81.3125 C24.02872247 80.76284628 18.66068315 79.07105798 13.0234375 77.25 C6.25711131 75.19440723 -0.09528367 75.09556157 -7.125 75.0625 C-8.19427734 75.041875 -9.26355469 75.02125 -10.36523438 75 C-18.00370714 74.96307687 -24.74875119 76.13047032 -32.0625 78.3125 C-30.54512418 75.05546029 -29.43595344 73.58412092 -26.3125 71.75 C-25.60351562 71.3271875 -24.89453125 70.904375 -24.1640625 70.46875 C-22.37839482 69.48630087 -20.53700024 68.60625011 -18.6875 67.75 C-15.71298499 66.12109892 -15.29543766 65.36766109 -14.0625 62.3125 C-12.7544208 55.87692072 -12.86266362 49.13148921 -12.74609375 42.58984375 C-12.72531265 41.60375626 -12.70453156 40.61766876 -12.68312073 39.60169983 C-12.61829082 36.48453015 -12.55905316 33.36728392 -12.5 30.25 C-12.45675131 28.1230393 -12.41313511 25.99608603 -12.36914062 23.86914062 C-12.26267873 18.68367006 -12.16122843 13.49812334 -12.0625 8.3125 C-13.67580173 8.77622101 -15.28757639 9.24525716 -16.89868164 9.71655273 C-18.24525597 10.10749367 -18.24525597 10.10749367 -19.61903381 10.5063324 C-22.3418761 11.40467396 -24.3073279 12.53126927 -26.5 14.375 C-27.11746094 14.88160156 -27.73492187 15.38820313 -28.37109375 15.91015625 C-28.92925781 16.37292969 -29.48742188 16.83570312 -30.0625 17.3125 C-31.0525 17.9725 -32.0425 18.6325 -33.0625 19.3125 C-32.49245204 15.63309956 -31.55569085 12.95731223 -29.5625 9.8125 C-29.1190625 9.0803125 -28.675625 8.348125 -28.21875 7.59375 C-20.19453071 -0.89564142 -10.87981442 -0.30812769 0 0 Z" transform="translate(64.0625,21.6875)"/>
    <path d="M0 0 C3.96 0 7.92 0 12 0 C12 9.9 12 19.8 12 30 C15.465 29.505 15.465 29.505 19 29 C20.36839363 26.26321275 20.21634818 23.95735576 20.31640625 20.8984375 C20.35830078 19.68671875 20.40019531 18.475 20.44335938 17.2265625 C20.48267578 15.95554687 20.52199219 14.68453125 20.5625 13.375 C20.60568359 12.09625 20.64886719 10.8175 20.69335938 9.5 C20.7996981 6.33346918 20.9003767 3.16674921 21 0 C24.96 0 28.92 0 33 0 C33 12.54 33 25.08 33 38 C23 38 23 38 21 37 C20.41089844 37.30164063 19.82179687 37.60328125 19.21484375 37.9140625 C15.08047583 39.94114236 10.48981719 39.55208123 6 39 C2.38308725 36.90219061 1.31708591 35.95125774 0 32 C-0.0845387 29.5589224 -0.11605786 27.14740787 -0.09765625 24.70703125 C-0.0962413 24.00100266 -0.09482635 23.29497406 -0.09336853 22.56755066 C-0.08777764 20.31582374 -0.07522688 18.06419679 -0.0625 15.8125 C-0.05748382 14.28450665 -0.05292112 12.75651173 -0.04882812 11.22851562 C-0.0378112 7.48563865 -0.02055287 3.74283627 0 0 Z" transform="translate(123,44)"/>
    <path d="M0 0 C0.69416016 -0.01611328 1.38832031 -0.03222656 2.10351562 -0.04882812 C6.58513243 -0.05308417 9.40846208 0.52575526 12.9375 3.3125 C15.91646141 6.54567458 16.33825538 8.82211082 16.44921875 13.171875 C16.48466797 14.28691406 16.52011719 15.40195312 16.55664062 16.55078125 C16.59047852 18.28908203 16.59047852 18.28908203 16.625 20.0625 C16.65916016 21.23683594 16.69332031 22.41117188 16.72851562 23.62109375 C16.81095173 26.51813389 16.88011811 29.41487298 16.9375 32.3125 C17.5975 32.3125 18.2575 32.3125 18.9375 32.3125 C18.0625 38.0625 18.0625 38.0625 16.9375 40.3125 C10.3125 39.5625 10.3125 39.5625 6.9375 37.3125 C6.23496094 37.7971875 5.53242188 38.281875 4.80859375 38.78125 C0.02775766 41.33102925 -4.78141716 41.09752583 -10.0625 40.3125 C-13.2887505 38.67511723 -15.42228168 36.59293664 -17.0625 33.3125 C-17.57287087 29.25869711 -17.95524541 25.1350342 -16.12109375 21.390625 C-13.52600977 18.10406096 -10.9840385 16.54079798 -7.0625 15.3125 C-3.94921875 15.1171875 -3.94921875 15.1171875 -0.75 15.1875 C0.31863281 15.20554687 1.38726562 15.22359375 2.48828125 15.2421875 C3.29652344 15.26539063 4.10476563 15.28859375 4.9375 15.3125 C3.84965032 12.06266865 3.84965032 12.06266865 1.9375 9.3125 C-2.84502409 9.12119904 -7.34461812 9.54223357 -12.0625 10.3125 C-13.82712683 7.22440305 -14.0625 6.07937864 -14.0625 2.3125 C-9.33065277 0.45382448 -5.03301597 -0.02349681 0 0 Z M-4.0625 23.3125 C-5.39437793 24.42416864 -5.39437793 24.42416864 -5.25 27.25 C-5.39528733 30.42142859 -5.39528733 30.42142859 -3.0625 32.3125 C-0.02905046 32.22365 -0.02905046 32.22365 2.9375 31.3125 C5.3669516 27.6683226 5.09929575 25.60008728 4.9375 21.3125 C1.12533819 21.3125 -0.69178748 21.76379425 -4.0625 23.3125 Z" transform="translate(327.0625,42.6875)"/>
    <path d="M0 0 C2.1875 1.09765625 2.1875 1.09765625 5.3125 3.09765625 C3.9925 5.40765625 2.6725 7.71765625 1.3125 10.09765625 C-3.4375 9.22265625 -3.4375 9.22265625 -5.6875 8.09765625 C-7.68710012 8.05766425 -9.68797242 8.05418826 -11.6875 8.09765625 C-11.6875 9.41765625 -11.6875 10.73765625 -11.6875 12.09765625 C-10.80707031 12.38898437 -9.92664063 12.6803125 -9.01953125 12.98046875 C3.17296512 17.28370276 3.17296512 17.28370276 6.3125 23.09765625 C6.86207629 27.0133873 6.69676299 29.25227767 5.0625 32.84765625 C2.48673499 36.15935412 0.28909717 37.77212386 -3.6875 39.09765625 C-12.26640803 39.71843133 -19.29904472 39.9227699 -26.6875 35.09765625 C-26.6875 31.18926759 -25.18182124 29.98171518 -22.6875 27.09765625 C-22.048125 27.40703125 -21.40875 27.71640625 -20.75 28.03515625 C-16.80017023 29.40550536 -12.86831985 29.99087696 -8.6875 30.09765625 C-8.0275 29.76765625 -7.3675 29.43765625 -6.6875 29.09765625 C-6.69724539 27.14976835 -6.69724539 27.14976835 -7.6875 25.09765625 C-10.55207246 23.64927822 -10.55207246 23.64927822 -14 22.59765625 C-18.53851243 21.09328931 -21.7147521 19.94099461 -24.6875 16.09765625 C-26.03044295 11.99544252 -26.11819711 8.26307195 -24.625 4.22265625 C-18.54749288 -2.44299672 -8.1619676 -2.74042807 0 0 Z" transform="translate(202.6875,43.90234375)"/>
    <path d="M0 0 C0 3.3 0 6.6 0 10 C2.97 10 5.94 10 9 10 C8.67 12.64 8.34 15.28 8 18 C5.36 18 2.72 18 0 18 C0.33 25.59 0.66 33.18 1 41 C4.465 40.505 4.465 40.505 8 40 C9.5625 41.75 9.5625 41.75 11 44 C10.875 46.1875 10.875 46.1875 10 48 C6.80843552 49.06385483 4.41502524 49.16677982 1.0625 49.1875 C-0.49791016 49.20876953 -0.49791016 49.20876953 -2.08984375 49.23046875 C-5.09923844 48.99214085 -6.60019703 48.80892276 -9 47 C-12.99653231 41.52160739 -12.3430148 35.60079572 -12.1875 29.125 C-12.17396484 28.05507813 -12.16042969 26.98515625 -12.14648438 25.8828125 C-12.11128624 23.25468489 -12.06204693 20.62760806 -12 18 C-13.98 18 -15.96 18 -18 18 C-18 15.36 -18 12.72 -18 10 C-16.02 10 -14.04 10 -12 10 C-12 7.03 -12 4.06 -12 1 C-7.89864774 0.35665063 -4.17263102 0 0 0 Z" transform="translate(242,34)"/>
    <path d="M0 0 C-0.66 3.63 -1.32 7.26 -2 11 C-3.093125 11.0825 -4.18625 11.165 -5.3125 11.25 C-8.98960131 11.64460943 -8.98960131 11.64460943 -10.875 13.875 C-12.63273302 17.19516236 -13.15151515 19.96969702 -13.31640625 23.66796875 C-13.35830078 24.56064453 -13.40019531 25.45332031 -13.44335938 26.37304688 C-13.50233398 27.76620117 -13.50233398 27.76620117 -13.5625 29.1875 C-13.60568359 30.12787109 -13.64886719 31.06824219 -13.69335938 32.03710938 C-13.79938543 34.35790188 -13.90019194 36.67893177 -14 39 C-17.63 39 -21.26 39 -25 39 C-25 26.46 -25 13.92 -25 1 C-21.7 1 -18.4 1 -15 1 C-14.67 1.99 -14.34 2.98 -14 4 C-13.54625 3.34 -13.0925 2.68 -12.625 2 C-8.54860457 -1.10582509 -5.03648067 -0.26507793 0 0 Z" transform="translate(297,43)"/>
</svg>
            </div>
        </div>
    </header>

    <main class="scaffold-body">
        
        <h1 class="title"><%= content.ai_title %></h1>
        <div class="description"><%= content.summary %></div>

        <div class="section-title"><%= labels.key_points %></div>
        <% (content.key_points || []).forEach(function(point) { %>
        <div class="bullet-point">
            <div class="bullet-dot"></div>
            <div class="bullet-text"><%= point %></div>
        </div>
        <% }); %>

        <div class="button-row">
            <% if (doc.attachmentUrls && doc.attachmentUrls[0]) { %>
            <a href="<%= doc.attachmentUrls[0] %>" target="_blank" class="outlined-btn">
                <span class="material-icons-outlined">article</span>
                <%= labels.official_text %>
            </a>
            <% } %>
        <% if (processUrl) { %>
            <a href="<%= processUrl %>" class="outlined-btn" target="_blank">
                <span class="material-icons-outlined">account_balance</span>
                <%= labels.process_page %>
            </a>
        <% } %>
        </div>

        <% if (doc.votesFor !== undefined && doc.votesFor !== null) { %>
        <div class="voting-section">
            <div class="voting-header"><%= labels.voting_results %></div>
            <div class="voting-date"><%= meta.votingDate %></div>
            
        <div id="hemicycle-container">
                <!-- LOGIKA OBLICZANIA PROCENTÓW (SERVER-SIDE) -->
                <% 
                    const vFor = doc.votesFor || 0;
                    const vAgainst = doc.votesAgainst || 0;
                    const vAbstain = doc.votesAbstain || 0;
                    const totalVotes = vFor + vAgainst + vAbstain;
                    
                    let badgePercent = "0%";
                    let badgeColor = "var(--vote-abstain)";

                    if (totalVotes > 0) {
                        if (vFor >= vAgainst) {
                            badgePercent = Math.round((vFor / totalVotes) * 100) + "%";
                            badgeColor = "var(--vote-for)";
                        } else {
                            badgePercent = Math.round((vAgainst / totalVotes) * 100) + "%";
                            badgeColor = "var(--vote-against)";
                        }
                    } else {
                        badgePercent = "N/A";
                    }
                %>

                <!-- WSTRZYKNIĘCIE OBLICZONEJ WARTOŚCI -->
                <div class="percentage-badge" id="percent-badge" style="color: <%= badgeColor %>">
                    <%= badgePercent %>
                </div>
            </div>

            <div class="vote-counts">
                <div class="vote-count-item">
                    <span class="vote-label"><%= labels.vote_for %></span>
                    <span class="vote-number" style="color: var(--vote-for);"><%= doc.votesFor || 0 %></span>
                </div>
                <div class="vote-count-item">
                    <span class="vote-label"><%= labels.vote_against %></span>
                    <span class="vote-number" style="color: var(--vote-against);"><%= doc.votesAgainst || 0 %></span>
                </div>
                <div class="vote-count-item">
                    <span class="vote-label"><%= labels.vote_abstained %></span>
                    <span class="vote-number" style="color: var(--vote-abstain);"><%= doc.votesAbstain || 0 %></span>
                </div>
            </div>
        </div>
        <% } %>

        <% if (doc.votingUrl) { %>
        <a href="<%= doc.votingUrl %>" target="_blank" rel="nofollow" class="pdf-link">
            <span class="link-text"><%= labels.full_results_pdf %></span>
            <span class="material-icons">open_in_new</span>
        </a>
        <% } %>

        <div class="status-container">
            <% 
                const statusKey = doc.status;
                const translatedStatus = (labels.status && labels.status[statusKey]) ? labels.status[statusKey] : statusKey;
            %>
            <span class="status-text"><%= translatedStatus %></span>
        </div>

        <div class="citizen-poll">
            <div class="poll-title"><%= labels.citizen_poll %></div>
            
            <% 
                const cLikes = doc.likes || 0;
                const cDislikes = doc.dislikes || 0;
                const cTotal = cLikes + cDislikes;
            %>

            <div class="poll-bar-container">
                <% if (cTotal > 0) { 
                    const cLikePct = Math.round((cLikes / cTotal) * 100);
                    const cDislikePct = 100 - cLikePct; 
                %>
                    <!-- STAN AKTYWNY (KOLORY) -->
                    <div class="poll-segment" style="width: <%= cLikePct %>%; background-color: var(--vote-for);">
                        <%= cLikePct > 0 ? cLikePct + '%' : '' %>
                    </div>
                    <div class="poll-segment" style="width: <%= cDislikePct %>%; background-color: var(--vote-against);">
                        <%= cDislikePct > 0 ? cDislikePct + '%' : '' %>
                    </div>
                <% } else { %>
                    <!-- STAN PUSTY (High Contrast / No Border Artifacts) -->
                    <div class="poll-segment" style="width: 100%; background-color: #EEEEEE; color: #212121; font-weight: 500;">
                        <%= labels.no_votes_cast %>
                    </div>
                <% } %>
            </div>

            <div class="poll-login-container">
                <!-- DEEP LINK: Otwiera tę konkretną ustawę w aplikacji -->
                <a href="https://lustra.news/#/login?next=/<%= lang %>/<%= institutionSlug %>/<%= term %>/<%= typeSlug %>/<%= doc.id %>/" class="poll-login-btn">
                    <span class="material-icons-outlined">login</span>
                    <%= labels.login_to_vote %>
                </a>
            </div>
        </div>

        <div class="meta-title"><%= labels.additional_info %></div>
        
        <% if (doc.id) { %>
        <div class="meta-item"><%= labels.print_number %> <%= doc.id %></div>
        <% } %>

        <% if (doc.sponsor && doc.sponsor.name) { %>
        <div class="meta-item"><%= labels.sponsor %> <%= doc.sponsor.name %></div>
        <% } %>

        <% if (meta.processStartDate) { %>
        <div class="meta-item"><%= labels.process_start %> <%= meta.processStartDate %></div>
        <% } %>

        <% if (meta.votingDate) { %>
        <div class="meta-item"><%= labels.voting_date %> <%= meta.votingDate %></div>
        <% } %>

        <% if (doc.proceeding) { %>
        <div class="meta-item"><%= labels.meeting_no %> <%= doc.proceeding %></div>
        <% } %>

        <% if (doc.votingNumber) { %>
        <div class="meta-item"><%= labels.voting_no %> <%= doc.votingNumber %></div>
        <% } %>

        <div class="footer-section">
            <div class="footer-text"><%= labels.footer_ai %></div>
            <% if (aiModel) { %>
            <div class="footer-text"><%= labels.summarized_by %> <%= aiModel %></div>
            <% } %>
            <% if (sourceApi) { %>
            <div class="footer-text"><%= labels.footer_source %> <%= sourceApi %></div>
            <% } %>
            
            <a href="https://storage.googleapis.com/lustra-logs/<%= geoRegion.toLowerCase() %>/legislations/<%= doc.id %>.json" target="_blank" rel="nofollow" class="source-link">
                <%= labels.view_source_json %>
                <span class="material-icons">launch</span>
            </a>
        </div>
    </main>

<!-- === SEO LAYER: CONTEXT & NAVIGATION (BELOW THE FOLD) === -->
    <section class="seo-container">
        <div class="seo-divider"></div>

        <!-- 2. SEMANTIC CONTEXT (Machine Logic) -->
        <div class="legal-context">
            
            <!-- 1. OFFICIAL TITLE (Bez zmian, prosto) -->
            <div class="context-item">
                <h2><%= labels.official_legal_title %></h2>
                <p style="font-weight: 500; color: #000; margin-bottom: 0;"><%= doc.titleOfficial %></p>
            </div>

            <div class="seo-divider" style="margin: 20px 0; opacity: 0.3;"></div>

            <!-- 2. EXPANDED FAQ (Snippet Food) -->
            <div class="context-item">
                <h2><%= labels.faq_title %></h2>
                
                <!-- Q: ID -->
                <% if (doc.id) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_id %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_id %> <%= doc.id %>.
                    </p>
                </details>
                <% } %>

                <!-- Q: ORIGIN -->
                <% 
                   let visualOrigin = null;
                   if (doc.id && doc.id.includes("_H")) visualOrigin = labels.unit_house;
                   else if (doc.id && doc.id.includes("_S")) visualOrigin = labels.unit_senate;
                %>
                
                <% if (visualOrigin) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_origin %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_origin %> <strong><%= visualOrigin %></strong>.
                    </p>
                </details>
                <% } %>

                <!-- Q: START DATE -->
                <% if (meta.processStartDate) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_start %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_start %> <strong><%= meta.processStartDate %></strong>.
                    </p>
                </details>
                <% } %>

                <!-- Q: KEY PROVISIONS -->
                <% if (content.key_points && content.key_points.length > 0) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_provisions %></summary>
                    <div style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <p style="margin-bottom: 6px;"><%= labels.ans_provisions %></p>
                        <ul style="padding-left: 20px; margin: 0;">
                            <% content.key_points.forEach(function(point) { %>
                                <li style="margin-bottom: 4px;"><%= point %></li>
                            <% }); %>
                        </ul>
                    </div>
                </details>
                <% } %>

                <!-- Q: STATUS DETAIL -->
                <% if (doc.status) { 
                    const sKey = doc.status;
                    const sTrans = (labels.status && labels.status[sKey]) ? labels.status[sKey] : sKey;
                %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_status %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_status %> <strong><%= sTrans %></strong>.
                    </p>
                </details>
                <% } %>

                <!-- Q: FULL TEXT SOURCE -->
                <% if (doc.attachmentUrls && doc.attachmentUrls[0]) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_text %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_text %>
                        <a href="<%= doc.attachmentUrls[0] %>" target="_blank" rel="nofollow" style="color: var(--primary); text-decoration: underline;">
                            <%= labels.ans_view_full_text %>
                        </a>
                    </p>
                </details>
                <% } %>

                <!-- Q: OFFICIAL VOTING RECORD -->
                <% if (doc.votingUrl) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_votes %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_votes %>
                        <a href="<%= doc.votingUrl %>" target="_blank" rel="nofollow" style="color: var(--primary); text-decoration: underline;">
                            <%= labels.ans_view_voting_record %>
                        </a>
                    </p>
                </details>
                <% } %>

                <!-- Q: SPONSOR -->
                <% if (doc.sponsor && doc.sponsor.name) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_sponsor %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_sponsor %> <strong><%= doc.sponsor.name %></strong>.
                    </p>
                </details>
                <% } %>
                

                <!-- Q: LATEST ACTION (statusText) -->
                <% if (doc.statusText) { %>
                <details style="margin-bottom: 12px; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_latest_action %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.ans_latest_action %> <%= doc.statusText %>
                    </p>
                </details>
                <% } %>

                <!-- Q: TRUST / JUDGE -->
                <% if (meta.judgeDate) { %>
                <details style="margin-bottom: 0; cursor: pointer;">
                    <summary style="font-size: 14px; color: var(--primary); font-weight: 500;"><%= labels.faq_verified %></summary>
                    <p style="margin-top: 6px; font-size: 14px; color: var(--text-med);">
                        <%= labels.faq_verified_answer %> <%= meta.judgeDate %>.
                    </p>
                </details>
                <% } %>

            </div>

            <div class="seo-divider" style="margin: 20px 0; opacity: 0.3;"></div>

            <div class="context-item">
                <h2><%= labels.categories_title || "CATEGORIES" %></h2>
                <div class="tag-cloud">
                    <% (doc.category || []).forEach(function(tag) { 
                        const translatedTag = (labels.categories && labels.categories[tag]) ? labels.categories[tag] : tag;
                    %>
                    <a href="/<%= lang %>/<%= institutionSlug %>/topics/<%= slugify(tag) %>/" class="seo-tag" style="text-decoration: none; color: inherit;">
                        <%= translatedTag %>
                    </a>
                    <% }); %>
                </div>
            </div>
        </div>

        <footer class="seo-footer" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E0E0E0; display: flex; flex-direction: column; align-items: center; text-align: center;">
            
            <!-- NAV LINK (Jako część footera) -->
            <a href="/<%= lang %>/<%= institutionSlug %>/<%= term %>" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary); font-size: 13px; font-weight: 500; margin-bottom: 16px;">
                <span class="material-icons" style="font-size: 16px; margin-right: 6px;">grid_view</span>
                <%= term %> <%= labels.nav_index %>
            </a>

            <!-- DISCLAIMER & COPYRIGHT -->
            <p style="font-size: 11px; color: var(--text-low); margin: 0; max-width: 600px; line-height: 1.4;">
                Lustra.news &copy; 2026. Civic Intelligence Data Node.<br>
                Generated: <%= meta.generatedAt %> This page summarizes public-domain legislative data to improve civic accessibility. Official texts remain the authoritative source.<br>
                <br>
            </p>
        </footer>
    </section>

    <!-- LOGIKA JS (Hemicycle) - Renderujemy tylko jeśli sekcja istnieje -->
    <% if (doc.votesFor !== undefined && doc.votesFor !== null) { %>
    <script>
        function drawHemicycle() {
            const votesFor = <%= doc.votesFor || 0 %>;
            const votesAgainst = <%= doc.votesAgainst || 0 %>;
            const votesAbstain = <%= doc.votesAbstain || 0 %>;
            
            const fixedTotalDots = 117;
            const spacingFraction = 0.15; 
            
            const colorFor = "#4CAF50";
            const colorAgainst = "#F44336";
            const colorAbstain = "#9E9E9E";

            const actualTotalVotes = votesFor + votesAgainst + votesAbstain;
            if (actualTotalVotes === 0) return;

            let pFor = votesFor / actualTotalVotes;
            let pAgainst = votesAgainst / actualTotalVotes;
            let pAbstain = votesAbstain / actualTotalVotes;

            let numDotsFor = Math.floor(pFor * fixedTotalDots);
            let numDotsAgainst = Math.floor(pAgainst * fixedTotalDots);
            let numDotsAbstain = Math.floor(pAbstain * fixedTotalDots);

            let remainderDots = fixedTotalDots - (numDotsFor + numDotsAgainst + numDotsAbstain);
            let fractionalParts = [
                { idx: 0, val: (pFor * fixedTotalDots) - numDotsFor },
                { idx: 1, val: (pAgainst * fixedTotalDots) - numDotsAgainst },
                { idx: 2, val: (pAbstain * fixedTotalDots) - numDotsAbstain }
            ];
            fractionalParts.sort((a, b) => b.val - a.val);

            for (let k = 0; k < remainderDots; k++) {
                if (fractionalParts[k].idx === 0) numDotsFor++;
                else if (fractionalParts[k].idx === 1) numDotsAgainst++;
                else numDotsAbstain++;
            }

            let dotColors = [];
            for(let i=0; i<numDotsFor; i++) dotColors.push(colorFor);
            for(let i=0; i<numDotsAgainst; i++) dotColors.push(colorAgainst);
            for(let i=0; i<numDotsAbstain; i++) dotColors.push(colorAbstain);

            const chartFullWidth = 460; 
            const chartHeight = 230;    
            
            const chartCenterX = chartFullWidth / 2;
            const chartFocalY = chartHeight;
            const chartOuterRadius = Math.min(chartCenterX, chartFocalY);
            const chartInnerRadiusRatio = 0.35;
            const chartInnerRadius = chartOuterRadius * chartInnerRadiusRatio;

            const annulusArea = (Math.PI / 2.0) * (Math.pow(chartOuterRadius, 2) - Math.pow(chartInnerRadius, 2));
            
            let initialDotDiameterEstimate = Math.sqrt(annulusArea / fixedTotalDots) / (1 + spacingFraction);
            if (!initialDotDiameterEstimate || initialDotDiameterEstimate <= 0) initialDotDiameterEstimate = 4.0;
            
            const maxAllowableDotDiameter = 22.0; 
            const minAllowableDotDiameter = 1.0;

            let currentEstimatedDotDiameter = Math.max(minAllowableDotDiameter, Math.min(maxAllowableDotDiameter, initialDotDiameterEstimate));
            
            let dotRadius = 0;
            let interDotSpacing = 0;
            let numRows = 0;
            let rowHeight = 0;

            let loopGuard = 0;
            while (loopGuard < 20) {
                dotRadius = currentEstimatedDotDiameter / 2.0;
                interDotSpacing = currentEstimatedDotDiameter * spacingFraction;
                let tempRowHeight = currentEstimatedDotDiameter + interDotSpacing;
                
                numRows = Math.floor((chartOuterRadius - chartInnerRadius) / tempRowHeight);
                if (numRows < 1) numRows = 1;

                let totalAvailableSlots = 0;
                for (let i = 0; i < numRows; i++) {
                    let currentRowNominalRadius = chartInnerRadius + (i * tempRowHeight) + (tempRowHeight / 2);
                    let maxDotsInThisRow = Math.floor((Math.PI * currentRowNominalRadius) / (currentEstimatedDotDiameter + interDotSpacing));
                    totalAvailableSlots += maxDotsInThisRow;
                }

                if (totalAvailableSlots >= fixedTotalDots || currentEstimatedDotDiameter <= minAllowableDotDiameter) {
                    rowHeight = tempRowHeight;
                    break;
                }
                currentEstimatedDotDiameter = Math.max(minAllowableDotDiameter, currentEstimatedDotDiameter * 0.95);
                loopGuard++;
            }

            let svgHtml = `<svg width="${chartFullWidth}" height="${chartHeight}" viewBox="0 0 ${chartFullWidth} ${chartHeight}">`;
            let dotsDrawnCount = 0;
            
            for (let i = 0; i < numRows; i++) {
                if (dotsDrawnCount >= fixedTotalDots) break;
                
                let currentRowNominalRadius = chartInnerRadius + (i * rowHeight) + (rowHeight / 2);
                let maxDotsInThisRow = Math.floor((Math.PI * currentRowNominalRadius) / (currentEstimatedDotDiameter + interDotSpacing));
                
                if (maxDotsInThisRow === 0) continue;
                
                let angleStep = Math.PI / maxDotsInThisRow;
                
                for (let j = 0; j < maxDotsInThisRow; j++) {
                    if (dotsDrawnCount >= fixedTotalDots) break;
                    
                    let angle = Math.PI - (j * angleStep) - (angleStep / 2);
                    let dotX = chartCenterX + currentRowNominalRadius * Math.cos(angle);
                    let dotY = chartFocalY - currentRowNominalRadius * Math.sin(angle);
                    let color = dotColors[dotsDrawnCount];
                    
                    svgHtml += `<circle cx="${dotX}" cy="${dotY}" r="${dotRadius}" fill="${color}" />`;
                    dotsDrawnCount++;
                }
            }
            svgHtml += `</svg>`;

            const container = document.getElementById('hemicycle-container');
            container.innerHTML = svgHtml + container.innerHTML; 
            
            const badge = document.getElementById('percent-badge');
            let winnerColor = colorAbstain;
            if (votesFor >= votesAgainst && votesFor >= votesAbstain) winnerColor = colorFor;
            else if (votesAgainst >= votesFor && votesAgainst >= votesAbstain) winnerColor = colorAgainst;
            badge.style.color = winnerColor;
        }

        drawHemicycle();
    </script>
    <% } %>
</body>
</html>